#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

staged_files="$(git diff --cached --name-only || true)"
if [[ -z "$staged_files" ]]; then
  exit 0
fi

requires_reload="false"
while IFS= read -r file_path; do
  [[ -z "$file_path" ]] && continue
  if [[ "$file_path" == "AGENTS.md" ]]; then
    requires_reload="true"
    break
  fi
  if [[ "$file_path" == skills/* ]]; then
    requires_reload="true"
    break
  fi
  if [[ "$file_path" =~ ^workspace/.+/prj-docs/PROJECT_AGENT\.md$ ]]; then
    requires_reload="true"
    break
  fi
done <<< "$staged_files"

if [[ "$requires_reload" != "true" ]]; then
  :
else
  echo "[pre-commit] codex skills reload validation"
  bash -n skills/aki-codex-session-reload/scripts/codex_skills_reload/*.sh
  ./skills/aki-codex-session-reload/scripts/codex_skills_reload/session_start.sh >/dev/null
  echo "[pre-commit] ok"
fi

runtime_mode_file=".codex/runtime/precommit_mode"
chain_mode="${CHAIN_VALIDATION_MODE:-}"
if [[ -z "$chain_mode" ]] && [[ -f "$runtime_mode_file" ]]; then
  chain_mode="$(tr -d '[:space:]' < "$runtime_mode_file")"
fi
chain_mode="${chain_mode:-quick}"

echo "[pre-commit] policy chain validation (mode: ${chain_mode})"
bash skills/aki-codex-precommit/scripts/validate-precommit-chain.sh --mode "$chain_mode"
echo "[pre-commit] policy chain ok (${chain_mode})"
