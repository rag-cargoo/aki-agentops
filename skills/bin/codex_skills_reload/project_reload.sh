#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(git -C "$script_dir" rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "$repo_root" ]]; then
  repo_root="$(cd "$script_dir/../../.." && pwd)"
fi
workspace_dir="$repo_root/workspace"
active_file="$workspace_dir/.active_project"
runtime_dir="$repo_root/.codex/runtime"
output_file="$runtime_dir/codex_project_reload.md"

version="$(date +%Y%m%d-%H%M%S)"
updated_at="$(date '+%Y-%m-%d %H:%M:%S')"

if [[ ! -d "$workspace_dir" ]]; then
  echo "error: workspace directory not found: $workspace_dir" >&2
  exit 1
fi
mkdir -p "$runtime_dir"

mapfile -t task_files < <(find "$workspace_dir/apps" -type f -path "*/prj-docs/task.md" 2>/dev/null | sort || true)
project_count="${#task_files[@]}"

declare -a project_roots=()
for task_file in "${task_files[@]}"; do
  project_root="$(dirname "$(dirname "$task_file")")"
  project_roots+=("$project_root")
done

active_project=""
if [[ -f "$active_file" ]]; then
  active_project="$(head -n 1 "$active_file" | tr -d '\r' | xargs)"
fi

# Auto-select when only one project exists and no active target is set.
if [[ -z "$active_project" && "$project_count" -eq 1 ]]; then
  active_project="${project_roots[0]#$repo_root/}"
  printf '%s\n' "$active_project" > "$active_file"
fi

active_task=""
active_agent=""
active_readme=""
declare -a active_missing=()
active_is_valid="false"
if [[ -n "$active_project" ]]; then
  active_abs="$repo_root/$active_project"
  candidate_readme="$active_abs/README.md"
  candidate_task="$active_abs/prj-docs/task.md"
  candidate_agent="$active_abs/prj-docs/PROJECT_AGENT.md"
  candidate_rules_dir="$active_abs/prj-docs/rules"

  if [[ ! -f "$candidate_readme" ]]; then
    active_missing+=("${candidate_readme#$repo_root/}")
  fi
  if [[ ! -f "$candidate_task" ]]; then
    active_missing+=("${candidate_task#$repo_root/}")
  fi
  if [[ ! -f "$candidate_agent" ]]; then
    active_missing+=("${candidate_agent#$repo_root/}")
  fi
  if [[ ! -d "$candidate_rules_dir" ]]; then
    active_missing+=("${candidate_rules_dir#$repo_root/}/")
  fi

  if [[ "${#active_missing[@]}" -eq 0 ]]; then
    active_is_valid="true"
    active_readme="${candidate_readme#$repo_root/}"
    active_task="${candidate_task#$repo_root/}"
    active_agent="${candidate_agent#$repo_root/}"
  fi
fi

{
  echo "# Codex Project Reload"
  echo
  echo "- Version: \`$version\`"
  echo "- Updated At: \`$updated_at\`"
  echo "- Generated By: \`skills/bin/codex_skills_reload/project_reload.sh\`"
  echo
  echo "## Active Project"
  if [[ "$active_is_valid" == "true" ]]; then
    echo "- Project Root: \`$active_project\`"
    echo "- Project README: \`$active_readme\`"
    echo "- Task Doc: \`$active_task\`"
    echo "- Project Agent: \`$active_agent\`"
  else
    echo "- Project Root: \`(not selected)\`"
    if [[ -n "$active_project" && "${#active_missing[@]}" -gt 0 ]]; then
      echo "- Reason: active project is missing baseline files/directories"
      local_missing_idx=1
      for missing_item in "${active_missing[@]}"; do
        echo "  $local_missing_idx) \`$missing_item\`"
        local_missing_idx=$((local_missing_idx + 1))
      done
      echo "- Action: \`./skills/bin/codex_skills_reload/init_project_docs.sh $active_project\`"
      echo "- Action: \`./skills/bin/codex_skills_reload/set_active_project.sh $active_project\`"
    elif [[ "$project_count" -gt 1 ]]; then
      echo "- Reason: multiple projects detected. run \`./skills/bin/codex_skills_reload/set_active_project.sh <project-root>\`"
    elif [[ "$project_count" -eq 0 ]]; then
      echo "- Reason: no project with \`prj-docs/task.md\` found under \`workspace/apps\`"
    else
      echo "- Reason: invalid active project path. run \`./skills/bin/codex_skills_reload/set_active_project.sh <project-root>\`"
    fi
  fi
  echo
  echo "## Detected Projects"
  if [[ "$project_count" -eq 0 ]]; then
    echo "1. \`(none)\`"
  else
    idx=1
    for i in "${!project_roots[@]}"; do
      project_rel="${project_roots[$i]#$repo_root/}"
      task_rel="${task_files[$i]#$repo_root/}"
      marker=""
      if [[ "$project_rel" == "$active_project" && "$active_is_valid" == "true" ]]; then
        marker=" [ACTIVE]"
      fi
      echo "$idx. \`$project_rel\`$marker"
      echo "   - task: \`$task_rel\`"
      idx=$((idx + 1))
    done
  fi
  echo
  echo "## Usage"
  echo "1. 기본 리로드는 \`./skills/bin/codex_skills_reload/session_start.sh\` 사용 (권장)"
  echo "2. 신규/다중 프로젝트면 \`./skills/bin/codex_skills_reload/set_active_project.sh <project-root>\` 실행"
  echo "3. 이 문서를 읽고 Active Project의 \`README.md\` + \`PROJECT_AGENT.md\` + \`task.md\`를 로드"
} > "$output_file"

echo "updated: $output_file"
echo "project_count: $project_count"
