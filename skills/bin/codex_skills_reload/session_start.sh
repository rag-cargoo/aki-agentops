#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(git -C "$script_dir" rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "$repo_root" ]]; then
  repo_root="$(cd "$script_dir/../../.." && pwd)"
fi
bin_root="$repo_root/skills/bin"

runtime_dir="$repo_root/.codex/runtime"
skills_snapshot="$runtime_dir/codex_skills_reload.md"
project_snapshot="$runtime_dir/codex_project_reload.md"
session_snapshot="$runtime_dir/codex_session_start.md"
handoff_file="$repo_root/mcp/runtime/SESSION_HANDOFF.md"

"$script_dir/skills_reload.sh" >/dev/null
"$script_dir/project_reload.sh" >/dev/null
mkdir -p "$runtime_dir"

mapfile -t loaded_skills < <(find "$repo_root/skills" -mindepth 2 -maxdepth 2 -type f -name "SKILL.md" | sort)

active_project=""
active_readme=""
active_task=""
active_agent=""
active_meeting_notes=""
if [[ -f "$project_snapshot" ]]; then
  active_project="$(grep -E '^- Project Root:' "$project_snapshot" | sed -E 's/^- Project Root: `([^`]+)`/\1/' || true)"
  active_readme="$(grep -E '^- Project README:' "$project_snapshot" | sed -E 's/^- Project README: `([^`]+)`/\1/' || true)"
  active_task="$(grep -E '^- Task Doc:' "$project_snapshot" | sed -E 's/^- Task Doc: `([^`]+)`/\1/' || true)"
  active_agent="$(grep -E '^- Project Agent:' "$project_snapshot" | sed -E 's/^- Project Agent: `([^`]+)`/\1/' || true)"
  active_meeting_notes="$(grep -E '^- Meeting Notes:' "$project_snapshot" | sed -E 's/^- Meeting Notes: `([^`]+)`/\1/' || true)"
fi

handoff_status="NONE"
handoff_created=""
handoff_reason=""
if [[ -s "$handoff_file" ]]; then
  handoff_status="PENDING"
  handoff_created="$(grep -E '^- Created At:' "$handoff_file" | head -n 1 | sed -E 's/^- Created At: `([^`]+)`/\1/' || true)"
  handoff_reason="$(grep -E '^- Reason:' "$handoff_file" | head -n 1 | sed -E 's/^- Reason: ?//' || true)"
fi

skills_status="OK"
project_status="OK"
bin_status="OK"

required_bin_scripts=(
  "create-backup-point.sh"
  "sync-skill.sh"
  "codex_skills_reload/session_start.sh"
  "codex_skills_reload/skills_reload.sh"
  "codex_skills_reload/project_reload.sh"
  "codex_skills_reload/set_active_project.sh"
  "codex_skills_reload/init_project_docs.sh"
)

missing_bin_scripts=()
for s in "${required_bin_scripts[@]}"; do
  if [[ ! -x "$bin_root/$s" ]]; then
    missing_bin_scripts+=("$s")
  fi
done

if [[ ! -f "$skills_snapshot" || "${#loaded_skills[@]}" -eq 0 ]]; then
  skills_status="WARN"
fi

if [[ -z "$active_project" || "$active_project" == "(not selected)" ]]; then
  project_status="WARN"
fi

if [[ "${#missing_bin_scripts[@]}" -gt 0 ]]; then
  bin_status="WARN"
fi

now_human="$(date '+%Y-%m-%d %H:%M:%S')"
now_ver="$(date '+%Y%m%d-%H%M%S')"

{
  echo "# Codex Session Start"
  echo
  echo "- Version: \`$now_ver\`"
  echo "- Updated At: \`$now_human\`"
  echo "- Generated By: \`skills/bin/codex_skills_reload/session_start.sh\`"
  echo
  echo "## Startup Checks"
  echo "- Skills Snapshot: \`$skills_status\`"
  echo "- Project Snapshot: \`$project_status\`"
  echo "- Skills Bin Integrity: \`$bin_status\`"
  if [[ "$bin_status" == "WARN" ]]; then
    echo "- Missing/Non-Executable: \`$(IFS=', '; echo "${missing_bin_scripts[*]}")\`"
    echo "- Action: \`chmod +x skills/bin/*.sh skills/bin/codex_skills_reload/*.sh\` 또는 누락 스크립트 복구"
  fi
  echo
  echo "## Loaded Skills"
  if [[ "${#loaded_skills[@]}" -eq 0 ]]; then
    echo "1. \`(none)\`"
  else
    idx=1
    for abs_path in "${loaded_skills[@]}"; do
      rel_path="${abs_path#$repo_root/}"
      echo "$idx. \`$rel_path\`"
      idx=$((idx + 1))
    done
  fi
  echo
  echo "## Active Project"
  if [[ -n "$active_project" && "$active_project" != "(not selected)" ]]; then
    echo "- Project Root: \`$active_project\`"
    [[ -n "$active_readme" ]] && echo "- Project README: \`$active_readme\`"
    [[ -n "$active_task" ]] && echo "- Task Doc: \`$active_task\`"
    [[ -n "$active_agent" ]] && echo "- Project Agent: \`$active_agent\`"
    [[ -n "$active_meeting_notes" ]] && echo "- Meeting Notes: \`$active_meeting_notes\`"
  else
    echo "- Project Root: \`(not selected)\`"
    echo "- Action: \`./skills/bin/codex_skills_reload/set_active_project.sh <project-root>\`"
  fi
  echo
  echo "## Session Handoff"
  if [[ "$handoff_status" == "PENDING" ]]; then
    echo "- Status: \`PENDING\`"
    echo "- File: \`mcp/runtime/SESSION_HANDOFF.md\`"
    [[ -n "$handoff_created" ]] && echo "- Created At: \`$handoff_created\`"
    [[ -n "$handoff_reason" ]] && echo "- Reason: $handoff_reason"
    echo "- Action: \`mcp/runtime/SESSION_HANDOFF.md\`를 먼저 읽고 이어서 진행"
  else
    echo "- Status: \`NONE\`"
  fi
  echo
  echo "## How It Works"
  echo "1. 전역 규칙은 \`AGENTS.md\` + \`skills/*/SKILL.md\`에서 로드"
  echo "2. 프로젝트 컨텍스트는 Active Project의 \`README.md\` + \`prj-docs/PROJECT_AGENT.md\` + \`prj-docs/meeting-notes/README.md\`에서 로드"
  echo "3. 멀티 프로젝트에서는 Active Project를 명시적으로 전환해서 충돌 방지"
  echo
  echo "## Multi Project Guide"
  echo "1. 프로젝트 목록 확인: \`./skills/bin/codex_skills_reload/set_active_project.sh --list\`"
  echo "2. 활성 프로젝트 지정: \`./skills/bin/codex_skills_reload/set_active_project.sh <project-root>\`"
  echo "3. 지정 후 \`./skills/bin/codex_skills_reload/session_start.sh\` 재실행"
  echo
  echo "## Quick Remind"
  echo "- 시작 문구: \`AGENTS.md만 읽고 시작해.\`"
  echo "- 세션 상태 문서: \`.codex/runtime/codex_session_start.md\`"
  echo "- 재시작 핸드오프: \`mcp/runtime/SESSION_HANDOFF.md\` (있으면 우선 로드)"
  echo "- 문제 시 재동기화: \`./skills/bin/codex_skills_reload/session_start.sh\`"
  echo
  echo "## Usage"
  echo "1. 세션 시작 시 \`./skills/bin/codex_skills_reload/session_start.sh\` 실행"
  echo "2. \`.codex/runtime/codex_session_start.md\` 기준으로 세션 첫 상태를 보고"
} > "$session_snapshot"

echo "updated: ${session_snapshot#$repo_root/}"
echo "skills: ${#loaded_skills[@]} ($skills_status)"
echo "project: ${active_project:-none} ($project_status)"
