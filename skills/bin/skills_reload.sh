#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "$script_dir/../.." && pwd)"
skills_dir="$repo_root/skills"
output_file="$skills_dir/codex_skills_reload.md"

version="$(date +%Y%m%d-%H%M%S)"
updated_at="$(date '+%Y-%m-%d %H:%M:%S')"

mapfile -t skill_files < <(find "$skills_dir" -mindepth 2 -maxdepth 2 -type f -name "SKILL.md" | sort)

{
  echo "# Codex Skills Reload"
  echo
  echo "- Version: \`$version\`"
  echo "- Updated At: \`$updated_at\`"
  echo "- Generated By: \`skills/bin/skills_reload.sh\`"
  echo
  echo "## Loaded Skills"
  if [[ ${#skill_files[@]} -eq 0 ]]; then
    echo "1. \`(none)\`"
  else
    idx=1
    for abs_path in "${skill_files[@]}"; do
      rel_path="${abs_path#$repo_root/}"
      echo "$idx. \`$rel_path\`"
      idx=$((idx + 1))
    done
  fi
  echo
  echo "## Usage"
  echo "1. 세션 시작 시 \`./skills/bin/skills_reload.sh\` 실행"
  echo "2. 이 문서를 읽고 나열된 \`SKILL.md\`를 로드"
} > "$output_file"

echo "updated: $output_file"
echo "skill_count: ${#skill_files[@]}"
