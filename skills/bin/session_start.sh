#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "$script_dir/../.." && pwd)"

skills_snapshot="$repo_root/skills/codex_skills_reload.md"
project_snapshot="$repo_root/workspace/codex_project_reload.md"
session_snapshot="$repo_root/workspace/codex_session_start.md"

"$script_dir/skills_reload.sh" >/dev/null
"$script_dir/project_reload.sh" >/dev/null

mapfile -t loaded_skills < <(find "$repo_root/skills" -mindepth 2 -maxdepth 2 -type f -name "SKILL.md" | sort)

active_project=""
active_task=""
active_agent=""
if [[ -f "$project_snapshot" ]]; then
  active_project="$(grep -E '^- Project Root:' "$project_snapshot" | sed -E 's/^- Project Root: `([^`]+)`/\1/' || true)"
  active_task="$(grep -E '^- Task Doc:' "$project_snapshot" | sed -E 's/^- Task Doc: `([^`]+)`/\1/' || true)"
  active_agent="$(grep -E '^- Project Agent:' "$project_snapshot" | sed -E 's/^- Project Agent: `([^`]+)`/\1/' || true)"
fi

skills_status="OK"
project_status="OK"

if [[ ! -f "$skills_snapshot" || "${#loaded_skills[@]}" -eq 0 ]]; then
  skills_status="WARN"
fi

if [[ -z "$active_project" || "$active_project" == "(not selected)" ]]; then
  project_status="WARN"
fi

now_human="$(date '+%Y-%m-%d %H:%M:%S')"
now_ver="$(date '+%Y%m%d-%H%M%S')"

{
  echo "# Codex Session Start"
  echo
  echo "- Version: \`$now_ver\`"
  echo "- Updated At: \`$now_human\`"
  echo "- Generated By: \`skills/bin/session_start.sh\`"
  echo
  echo "## Startup Checks"
  echo "- Skills Snapshot: \`$skills_status\`"
  echo "- Project Snapshot: \`$project_status\`"
  echo
  echo "## Loaded Skills"
  if [[ "${#loaded_skills[@]}" -eq 0 ]]; then
    echo "1. \`(none)\`"
  else
    idx=1
    for abs_path in "${loaded_skills[@]}"; do
      rel_path="${abs_path#$repo_root/}"
      echo "$idx. \`$rel_path\`"
      idx=$((idx + 1))
    done
  fi
  echo
  echo "## Active Project"
  if [[ -n "$active_project" && "$active_project" != "(not selected)" ]]; then
    echo "- Project Root: \`$active_project\`"
    [[ -n "$active_task" ]] && echo "- Task Doc: \`$active_task\`"
    [[ -n "$active_agent" ]] && echo "- Project Agent: \`$active_agent\`"
  else
    echo "- Project Root: \`(not selected)\`"
    echo "- Action: \`./skills/bin/set_active_project.sh <project-root>\`"
  fi
  echo
  echo "## Usage"
  echo "1. 세션 시작 시 \`./skills/bin/session_start.sh\` 실행"
  echo "2. \`workspace/codex_session_start.md\` 기준으로 세션 첫 상태를 보고"
} > "$session_snapshot"

echo "updated: ${session_snapshot#$repo_root/}"
echo "skills: ${#loaded_skills[@]} ($skills_status)"
echo "project: ${active_project:-none} ($project_status)"
